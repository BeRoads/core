/*global L: true */L.KML=L.FeatureGroup.extend({options:{async:!0},initialize:function(e,t){this._kml=e;this._layers={};this._addKML(jQuery.parseXML(e),null)},loadXML:function(e,t,n,r){r==undefined&&(r=this.options.async);n==undefined&&(n=this.options);var i=new window.XMLHttpRequest;i.open("GET",e,r);try{i.overrideMimeType("text/xml")}catch(s){}i.onreadystatechange=function(){if(i.readyState!=4)return;i.status==200&&t(i.responseXML,n)};i.send(null)},addKML:function(e,t,n){var r=this,i=function(e,t){r._addKML(e,t)};this.loadXML(e,i,t,n)},_addKML:function(e,t){var n=L.KML.parseKML(e);if(!n||!n.length)return;for(var r=0;r<n.length;r++){this.fire("addlayer",{layer:n[r]});this.addLayer(n[r])}this.latLngs=L.KML.getLatLngs(e)},latLngs:[]});L.Util.extend(L.KML,{parseKML:function(e){var t=this.parseStyle(e),n=e.getElementsByTagName("Folder"),r=[],i;for(var s=0;s<n.length;s++){if(!this._check_folder(n[s]))continue;i=this.parseFolder(n[s],t);i&&r.push(i)}n=e.getElementsByTagName("Placemark");for(var o=0;o<n.length;o++){if(!this._check_folder(n[o]))continue;i=this.parsePlacemark(n[o],e,t);i&&r.push(i)}return r},_check_folder:function(e,t){e=e.parentElement;while(e&&e.tagName!=="Folder")e=e.parentElement;return!e||e===t},parseStyle:function(e){function i(e){var t={};for(var n=0;n<e.childNodes.length;n++){var s=e.childNodes[n],o=s.tagName;if(!r[o])continue;if(o==="hotSpot")for(var u=0;u<s.attributes.length;u++)t[s.attributes[u].name]=s.attributes[u].nodeValue;else{var a=s.childNodes[0].nodeValue;if(o==="color"){t.opacity=parseInt(a.substring(0,2),16)/255;t.color="#"+a.substring(2,8)}else if(o==="width")t.weight=a;else if(o==="Icon"){l=i(s);l.href&&(t.href=l.href)}else o==="href"&&(t.href=a)}}return t}var t={},n=e.getElementsByTagName("Style"),r={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0};for(var s=0;s<n.length;s++){var o=n[s],u,a={},f={},l={};u=o.getElementsByTagName("LineStyle");u&&u[0]&&(a=i(u[0]));u=o.getElementsByTagName("PolyStyle");u&&u[0]&&(f=i(u[0]));f.color&&(a.fillColor=f.color);f.opacity&&(a.fillOpacity=f.opacity);u=o.getElementsByTagName("IconStyle");u&&u[0]&&(l=i(u[0]));l.href&&(a.icon=new L.KMLIcon({iconUrl:l.href,shadowUrl:null,iconAnchorRef:{x:l.x,y:l.y},iconAnchorType:{x:l.xunits,y:l.yunits}}));t["#"+o.getAttribute("id")]=a}return t},parseFolder:function(e,t){var n,r=[],i;n=e.getElementsByTagName("Folder");for(var s=0;s<n.length;s++){if(!this._check_folder(n[s],e))continue;i=this.parseFolder(n[s],t);i&&r.push(i)}n=e.getElementsByTagName("Placemark");for(var o=0;o<n.length;o++){if(!this._check_folder(n[o],e))continue;i=this.parsePlacemark(n[o],e,t);i&&r.push(i)}if(!r.length)return;return r.length===1?r[0]:new L.FeatureGroup(r)},parsePlacemark:function(e,t,n){var r,i,s,o={};s=e.getElementsByTagName("styleUrl");for(r=0;r<s.length;r++){var u=s[r].childNodes[0].nodeValue;for(var a in n[u])o[a]=n[u][a]}var f=[],l=["LineString","Polygon","Point"];for(i in l){var c=l[i];s=e.getElementsByTagName(c);for(r=0;r<s.length;r++){var h=this["parse"+c](s[r],t,o);h&&f.push(h)}}if(!f.length)return;var p=f[0];f.length>1&&(p=new L.FeatureGroup(f));var d,v="";s=e.getElementsByTagName("name");s.length&&(d=s[0].childNodes[0].nodeValue);s=e.getElementsByTagName("description");for(r=0;r<s.length;r++)for(i=0;i<s[r].childNodes.length;i++)v+=s[r].childNodes[i].nodeValue;d&&p.bindPopup("<h2>"+d+"</h2>"+v);return p},parseCoords:function(e){var t=e.getElementsByTagName("coordinates");return this._read_coords(t[0])},parseLineString:function(e,t,n){var r=this.parseCoords(e);if(!r.length)return;return new L.Polyline(r,n)},parsePoint:function(e,t,n){var r=e.getElementsByTagName("coordinates");if(!r.length)return;var i=r[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(i[1],i[0]),n)},parsePolygon:function(e,t,n){var r,i=[],s=[],o,u;r=e.getElementsByTagName("outerBoundaryIs");for(o=0;o<r.length;o++){u=this.parseCoords(r[o]);u&&i.push(u)}r=e.getElementsByTagName("innerBoundaryIs");for(o=0;o<r.length;o++){u=this.parseCoords(r[o]);u&&s.push(u)}if(!i.length)return;n.fillColor&&(n.fill=!0);return i.length===1?new L.Polygon(i.concat(s),n):new L.MultiPolygon(i,n)},getLatLngs:function(e){var t=e.getElementsByTagName("coordinates"),n=[];for(var r=0;r<t.length;r++)n=n.concat(this._read_coords(t[r]));return n},_read_coords:function(e){var t="",n=[],r;for(r=0;r<e.childNodes.length;r++)t+=e.childNodes[r].nodeValue;t=t.split(/[\s\n]+/);for(r=0;r<t.length;r++){var i=t[r].split(",");if(i.length<2)continue;n.push(new L.LatLng(i[1],i[0]))}return n}});L.KMLIcon=L.Icon.extend({createIcon:function(){var e=this._createIcon("icon");e.onload=function(){var t=new Image;t.src=this.src;this.style.width=t.width+"px";this.style.height=t.height+"px";if(this.anchorType.x==="UNITS_FRACTION"||this.anchorType.x==="fraction")e.style.marginLeft=-this.anchor.x*t.width+"px";if(this.anchorType.y==="UNITS_FRACTION"||this.anchorType.x==="fraction")e.style.marginTop=-(1-this.anchor.y)*t.height+"px";this.style.display=""};return e},_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t]);e.anchor=this.options.iconAnchorRef;e.anchorType=this.options.iconAnchorType}});L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}});